# Transcript Rendering Package

This directory contains code that renders the diplomatic transcript inside the web browser. 

## Usage

Generate the intermediate text markup file, e.g. by calling `SimpleTransform` (see Dependencies) via maven

    mvn --offline -q exec:java -Dexec.mainClass="de.faustedition.transcript.simple.SimpleTransform" < ${XML_INPUT_FILE}
    
The output is a JSON standoff markup format of the XML file. 

Load the `.js`-files in this directory into a web page. Calling `transcriptGeneration.createDiplomaticSvg(standoff_transcript, callback)`
 will generate an SVG rendering of the transcript in the HTML body. `standoff_transcript` is the output from above. 
 `callback` is an optional call back function which will be called with the generated SVG element as single argument.  

If you want to ensure that all web fonts are loaded prior to rendering, you can wrap the rendering call with the included webfont
 loader like so
 
    Faust.Fonts.active (/* render */)

## Dependencies

The rendering library relies on a proprietary text markup format. This can be generated from an XML file by calling
 `de.faustedition.transcript.simple.SimpleTransform.main()` found in `de.faustedition:faust:1.4`

## Directory Contents

### Utilities

`faust.js` General utility functions

`loadwebfonts.js`  Wrap the Google web font loader

`svg-utils.js` SVG utility functions


### Standoff annotation handling 

`text-annotation.js` Parse standoff markup

`adhoc-tree.js` Build a tree from the standoff annotations generated by `text-annotaion.js`  

`text-index.js` Standoff annotation index for fast lookup

### Layout


`transcript.js` Abstract transcript layout classes. These classes provide an interface and general functionality for
the layout process. This consists most importantly of a hierarchy of 'ViewComponent' classes. These classes need to be 
augmented by an implementation for a specific graphical output system or 'terminal' which could be e.g. SVG or HTML+CSS.
At the moment, the only implementation uses SVG, see `transcript-svg.js`

`transcript-svg.js` Augment the abstract classes in `transcript.js` to do the layout with an SVG 'terminal' 

`transcript-adhoc-tree.js` Initialize layout objects from document tree

`transcript-configuration-faust.js` Configure parameters for transcript layout. Most importantly, 
'Faust.TranscriptConfiguration.names' provides a set of handler functions that get called when an element 'name' is 
traversed and which construct and return a 'ViewComponent' element

`transcript-generation.js` Entry point for transcript generation


## Overview of the layout process

1. Annotated 'Text' object is initiated from an XML file
2. 'AdhocTree' element is constructed from 'Text' object for easier traversal, and to provide a tree interface for the
   layout code that originally operated on a multi-tree model
3. A tree of 'ViewComponent' objects is constructed from the 'AdhocTree' object. At the same time, the SVG frontend to
   the 'ViewComponent' will construct an SVG that resembles (but not one-to-one) the 'ViewComponent' tree
4. The layout process is run iteratively, walking the 'ViewComponent' tree and adjusting the position and size of the 
   various ViewComponents (and their SVG representations) until the layout converges to a stable state. 'ViewComponent's
   are positioned with the help of their 'FaustTranscript.Align' objects, which specify a relative position to another
   VC (typically the parent or preceding sibling). For example, a typical line of text is positioned right below its 
   preceding sibling line. In each iteration of the layout process, all Aligns of all traversed VCs are executed once,
   and after a number of iterations the layout should not change anymore.